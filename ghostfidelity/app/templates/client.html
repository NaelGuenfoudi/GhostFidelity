{% extends 'base.html' %}

{% block content %}
<div class="page active" id="client">
  <div class="page-title">Profil Client</div>

  <!-- Infos client -->
  <div class="client-info">
  <h2>{{ client.prenom }} {{ client.nom }}</h2>
  <p>{{ client.email }}</p>
  <p>Date de naissance : {{ client.birthday_date.strftime('%d/%m/%Y') }}</p>

  {% set today = today_date %}
  {% set birthday_this_year = client.birthday_date.replace(year=today.year) %}
  {% if birthday_this_year < today %}
    {% set next_birthday = birthday_this_year.replace(year=today.year + 1) %}
  {% else %}
    {% set next_birthday = birthday_this_year %}
  {% endif %}

  {% set days_remaining = (next_birthday - today).days %}

  {% if days_remaining == 0 %}
    <p>ğŸ‚ Aujourdâ€™hui câ€™est lâ€™anniversaire de ce client ! Une coupe gratuite est offerte ğŸ¥³</p>
  {% else %}
    <p>ğŸ Coupe gratuite dans {{ days_remaining }} jour{{ 's' if days_remaining > 1 else '' }} (Ã  son anniversaire).</p>
  {% endif %}
</div>


  <!-- QR code -->
  <div class="qr-code">
    <img src="data:image/png;base64,{{ qr_base64 }}" alt="QR Code Client" class="qr-img" />
  </div>

  <!-- Visites -->
  <div class="visits-counter">
    <h3>Visites globales effectuÃ©es</h3>
    <div class="count">{{ client.nombre_visites }}</div>

    <h3>Visites effectuÃ©es depuis la derniÃ¨re coupe offerte</h3>
    <div class="count">{{ client.avancement_visite }}</div>

    <!-- Progression coupe gratuite -->
    <div class="progress-bar">
      <div
        class="progress-fill"
        style="width: {{ (client.avancement_visite / 10 * 100)|round(0) }}%;"
      ></div>
    </div>

    <p style="color: #8a9bc0; font-size: 13px">
      {% if client.avancement_visite == 9 %}
        ğŸ Prochaine visite offerte !
      {% else %}
        {% set restantes = 10 - client.avancement_visite %}
        {{ restantes }} visite{{ 's' if restantes > 1 else '' }} restante{{ 's' if restantes > 1 else '' }} avant la coupe gratuite
      {% endif %}
    </p>

    <!-- RÃ©duction 14.99â‚¬ â€“ seulement si cycle en cours est < 6 -->
    {% set cycle = client.avancement_visite % 10 %}
    {% if cycle <= 5 %}
      <!-- Barre de progression rÃ©duction -->
      {% set reduction_progress = (cycle / 5 * 100)|round(0) %}
      <div class="progress-bar">
        <div
          class="progress-fill"
          style="width: {{ reduction_progress }}%;"
        ></div>
      </div>

      <!-- Texte rÃ©duction -->
      <p style="color: #8a9bc0; font-size: 13px">
        {% if cycle == 5 %}
          ğŸ Cette visite est en rÃ©duction Ã  14.99â‚¬ !
        {% else %}
          {% set restantes = 5 - cycle %}
          {{ restantes }} visite{{ 's' if restantes > 1 else '' }} restante{{ 's' if restantes > 1 else '' }} avant la rÃ©duction Ã  14.99â‚¬ !
        {% endif %}
      </p>
    {% endif %}
  </div>

  <!-- RÃ©compenses -->
  {% set cycle = client.avancement_visite % 10 %}

{% if client.avancement_visite == 9 %}
  <div class="reward-card">
    <h4>ğŸ‰ Coupe gratuite disponible !</h4>
    <p>
      Ce client a atteint 9 visites et peut bÃ©nÃ©ficier de la dixiÃ¨me coupe offerte.
    </p>
  </div>
{% elif client.avancement_visite == 0 and client.nombre_visites > 0 %}
  <div class="reward-card">
    <h4>ğŸ Coupe gratuite appliquÃ©e</h4>
    <p>
      Ce client a reÃ§u une coupe offerte lors de sa derniÃ¨re visite.
    </p>
  </div>
{% endif %}
{% if isBirthday %}
  <div class="reward-card">
    <h4>ğŸ Joyeux anniversaire ! Vu que c'est votre jour, on vous offre la coupe </h4>
    <p>
      Ce client bÃ©nÃ©ficie dâ€™une coupe offert vu que c'est son anniversaire
    </p>
  </div>
{% endif %}

{% if cycle == 4 %}
  <div class="reward-card">
    <h4>ğŸ‰ RÃ©duction Ã  14.99â‚¬ disponible !</h4>
    <p>
      Ce client peut bÃ©nÃ©ficier dâ€™une coupe Ã  tarif rÃ©duit (14.99â‚¬) lors de sa prochaine visite.
    </p>
  </div>
{% elif cycle == 5 %}
  <div class="reward-card">
    <h4>ğŸ RÃ©duction Ã  14.99â‚¬ appliquÃ©e</h4>
    <p>
      Ce client bÃ©nÃ©ficie dâ€™une coupe Ã  tarif rÃ©duit (14.99â‚¬) sur cette visite.
    </p>
  </div>
{% endif %}


  <!-- Actions admin (affichÃ©es uniquement si admin connectÃ©) -->
  {% if session.get('admin') %}
    <div class="admin-actions">
      <form action="/client/{{ client.uuid }}/add-coupe" method="POST">
        <button class="btn btn-primary" type="submit">+ Ajouter une visite</button>
      </form>
      <div class="admin-actions-row">
        <a href="/client/{{ client.uuid }}/modify" class="btn">Modifier les infos</a>
        <form
          action="/client/{{ client.uuid }}/delete"
          method="POST"
          onsubmit="return confirm('Supprimer ce client ?');"
          style="display: inline"
        >
          <button type="submit" class="btn btn-danger">Supprimer client</button>
        </form>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
